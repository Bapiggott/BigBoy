// Prisma schema for Big Boy Restaurant App
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ USER & AUTH ============

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  phone        String?  @unique
  passwordHash String?
  googleSub    String?  @unique
  name         String?
  avatarUrl    String?
  firstName    String
  lastName     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Loyalty
  loyaltyPoints  Int         @default(0)
  loyaltyTier    LoyaltyTier @default(BRONZE)
  lifetimePoints Int         @default(0)
  memberSince    DateTime    @default(now())

  // Relations
  orders          Order[]
  addresses       Address[]
  paymentMethods  PaymentMethod[]
  redeemedRewards UserReward[]
  giftCards       GiftCard[]
  preferences     UserPreferences?
  favorites       Favorite[]
  sessions        Session[]
  auditLogs       AuditLog[]

  @@map("users")
}

model Session {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String
  createdAt DateTime  @default(now())
  expiresAt DateTime
  revokedAt DateTime?

  @@index([userId])
  @@map("sessions")
}

model UserPreferences {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notifications
  pushEnabled  Boolean @default(true)
  emailEnabled Boolean @default(true)
  smsEnabled   Boolean @default(false)
  orderUpdates Boolean @default(true)
  promotions   Boolean @default(true)
  rewardAlerts Boolean @default(true)

  // App preferences
  defaultOrderType  OrderType @default(PICKUP)
  defaultLocationId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_preferences")
}

model Address {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  label     String // "Home", "Work", etc.
  street    String
  unit      String?
  city      String
  state     String
  zipCode   String
  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("addresses")
}

model PaymentMethod {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        PaymentType
  lastFour    String
  brand       String? // "Visa", "Mastercard", etc.
  expiryMonth Int?
  expiryYear  Int?
  isDefault   Boolean     @default(false)

  // For tokenized cards (from payment processor)
  token String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("payment_methods")
}

model GiftCard {
  id     String  @id @default(uuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  code          String  @unique
  balance       Decimal @db.Decimal(10, 2)
  initialAmount Decimal @db.Decimal(10, 2)
  isActive      Boolean @default(true)

  purchasedAt DateTime  @default(now())
  expiresAt   DateTime?

  @@map("gift_cards")
}

// ============ LOCATIONS ============

model Location {
  id      String @id @default(uuid())
  name    String
  address String
  city    String
  state   String
  zipCode String
  phone   String

  latitude  Decimal @db.Decimal(10, 8)
  longitude Decimal @db.Decimal(11, 8)

  // Hours stored as JSON: { "monday": { "open": "07:00", "close": "22:00" }, ... }
  hours Json

  // Amenities
  hasDineIn     Boolean @default(true)
  hasTakeout    Boolean @default(true)
  hasDriveThru  Boolean @default(false)
  hasWifi       Boolean @default(false)
  hasPlayground Boolean @default(false)
  isAccessible  Boolean @default(true)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]

  @@map("locations")
}

// ============ MENU ============

model Category {
  id          String  @id @default(uuid())
  name        String  @unique
  slug        String  @unique
  description String?
  imageUrl    String?
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)

  items MenuItem[]

  @@map("categories")
}

model MenuItem {
  id         String   @id @default(uuid())
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  name        String
  description String  @db.Text
  price       Decimal @db.Decimal(10, 2)
  imageUrl    String?

  calories Int?
  prepTime Int? // in minutes

  isPopular   Boolean @default(false)
  isNew       Boolean @default(false)
  isAvailable Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  modifierGroups MenuItemModifierGroup[]
  orderItems     OrderItem[]
  favorites      Favorite[]

  @@map("menu_items")
}

model ModifierGroup {
  id          String  @id @default(uuid())
  name        String
  description String?

  isRequired Boolean @default(false)
  minSelect  Int     @default(0)
  maxSelect  Int     @default(1)

  modifiers Modifier[]
  menuItems MenuItemModifierGroup[]

  @@map("modifier_groups")
}

model Modifier {
  id      String        @id @default(uuid())
  groupId String
  group   ModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  name        String
  price       Decimal @default(0) @db.Decimal(10, 2)
  calories    Int?
  isDefault   Boolean @default(false)
  isAvailable Boolean @default(true)

  orderItemModifiers OrderItemModifier[]

  @@map("modifiers")
}

model MenuItemModifierGroup {
  menuItemId      String
  modifierGroupId String

  menuItem      MenuItem      @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  modifierGroup ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)

  @@id([menuItemId, modifierGroupId])
  @@map("menu_item_modifier_groups")
}

// ============ ORDERS ============

model Order {
  id          String   @id @default(uuid())
  orderNumber String   @unique
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])

  type   OrderType
  status OrderStatus @default(PENDING)

  subtotal    Decimal    @db.Decimal(10, 2)
  tax         Decimal    @db.Decimal(10, 2)
  tip         Decimal    @default(0) @db.Decimal(10, 2)
  discount    Decimal    @default(0) @db.Decimal(10, 2)
  total       Decimal    @db.Decimal(10, 2)
  promoCodeId String?
  promoCode   PromoCode? @relation(fields: [promoCodeId], references: [id], onDelete: SetNull)

  // Contact info (may differ from user profile)
  customerName  String
  customerPhone String
  customerEmail String?

  // Payment
  paymentMethod String // "card", "cash", "gift_card", etc.
  paymentStatus PaymentStatus @default(PENDING)

  // Timing
  scheduledFor   DateTime?
  estimatedReady DateTime?
  completedAt    DateTime?

  // Loyalty
  pointsEarned   Int @default(0)
  pointsRedeemed Int @default(0)

  specialInstructions String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items OrderItem[]

  @@index([userId])
  @@index([locationId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model Favorite {
  userId     String
  menuItemId String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@id([userId, menuItemId])
  @@map("favorites")
}

model PromoCode {
  id          String    @id @default(uuid())
  code        String    @unique
  type        PromoType
  value       Decimal   @db.Decimal(10, 2)
  minSubtotal Decimal   @default(0) @db.Decimal(10, 2)
  isActive    Boolean   @default(true)
  startsAt    DateTime?
  endsAt      DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  orders Order[]

  @@map("promo_codes")
}

model OrderItem {
  id         String   @id @default(uuid())
  orderId    String
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItemId String
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])

  name       String // Snapshot of item name at time of order
  quantity   Int
  unitPrice  Decimal @db.Decimal(10, 2)
  totalPrice Decimal @db.Decimal(10, 2)

  specialInstructions String?

  modifiers OrderItemModifier[]

  @@map("order_items")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action    String
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([userId])
  @@map("audit_logs")
}

model OrderItemModifier {
  id          String    @id @default(uuid())
  orderItemId String
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  modifierId  String
  modifier    Modifier  @relation(fields: [modifierId], references: [id])

  name  String // Snapshot
  price Decimal @db.Decimal(10, 2)

  @@map("order_item_modifiers")
}

// ============ REWARDS ============

model Reward {
  id          String @id @default(uuid())
  name        String
  description String @db.Text

  pointsCost Int
  category   RewardCategory

  // Restrictions
  minTier        LoyaltyTier @default(BRONZE)
  validFrom      DateTime?
  validUntil     DateTime?
  maxRedemptions Int? // null = unlimited

  // Redemption tracking
  totalRedeemed Int @default(0)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userRewards UserReward[]

  @@map("rewards")
}

model UserReward {
  id       String @id @default(uuid())
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  rewardId String
  reward   Reward @relation(fields: [rewardId], references: [id])

  redemptionCode String    @unique
  redeemedAt     DateTime  @default(now())
  expiresAt      DateTime
  usedAt         DateTime?

  @@index([userId])
  @@index([expiresAt])
  @@map("user_rewards")
}

// ============ ENUMS ============

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
}

enum OrderType {
  PICKUP
  DINE_IN
  DELIVERY
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
}

enum PaymentType {
  CREDIT_CARD
  DEBIT_CARD
  GIFT_CARD
  APPLE_PAY
  GOOGLE_PAY
}

enum PromoType {
  PERCENT
  FIXED
  BOGO
}

enum RewardCategory {
  FOOD
  DRINK
  DESSERT
  COMBO
  MERCHANDISE
}
